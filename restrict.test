#!/bin/bash

function man_page ()
  { # Begin man page
  cat<< EOF
  NAME
       restrictaccess by Clen
  SYNOPSYS
       acctpasswd [options] USERNAME
  DESCRIPTION
       This script was designed to automatically create and remove .htaccess
       and .htpasswd restrictions which are in place due to Abuse or Legal
       department tickets.
       This is done by creating new or appending to existing .htaccess and
       .htpasswd files in the users home directory.
  OPTIONS
       -a CPANEL_USERNAME
            Add restrictions to specified USERNAME
       -r CPANEL_USERNAME
            Remove restrictions from specified USERNAME
       -c CPANEL_USERNAME
            Check for restrictions in place for USERNAME
       -h
            Displays this man page.
  Exiting.


EOF
} # End man page


function usage()
{
echo "this is help section"
echo "the is is the second line int he help section"
echo " -h for this one"
echo "-a for something lese"
echo "-d for next one"
}

function pu ()
{
echo "1starg =" $user
echo "dotyou :" $display_help
}

function check_user()
{
#checking whether the user actually exists.
if [[ -f /var/cpanel/users/$user ]]; then 
	user_exist=$(cat /etc/passwd | grep $user);
	user_path=$(cat /etc/passwd | grep $user |awk -F: '{print $6}');
	if [[ ! -z "$user_exist" ]]; then 
		echo "User : $user does not exist in this system."; exit 0;
else
	echo "$user is not a cpanel user."; exit 0;
}

function check_error()
{
##check existences of certain files and what needs to be present"
if [[ ! -f $user_path/.htpasswd ]];then
	echo "[+].htpasswd file present."
	echo "[+]Creating the .htpasswd file ."
	touch $user_path/.htpasswd;
	if [[ ! -f $user_path.htaccess ]]; then
		echo "[+].htaccess is not present."
		echo "[+]Creating the .htaccess fle in the path."
		touch $user_path/.htaccess;
	fi
fi
}

function check_immutable()
{
#this is to set/unset the restrictions on the account.

chwd=$(lsattr /etc/apache2/.htpasswd | awk '{print $1}'| grep -o "ia");

chcs=$(lsattr /etc/apache2/.htaccess | awk '{print $1}'| grep -o "ia");

if [[ $restrict == "1" ]]; then 
	if [[ -z $chwd && -z $chcs ]]; then

echo "number of parameters : "
echo $#

#echo "the second one is  $2"
#while test $# -gt 0;
while getopts ":h:a:*" opt;
do
	case $opt in
		h)
			man_page
			display_help=$OPTARG
			pu $display_help
			exit 0;
			;;

		a)	
			restrict=1;
			if [[ $3 == "http" ]];then
				user=$2;
				service=$3;
				check_user
				check_error
				check_immutable $restrict
			elif  [[ $3 == "exim" ]]; then
				user=$2;
                                service=$3;
                                check_user
                                restrict_user
			else [[ $3  == "ftp" ]]; then
				user=$2;
                                service=$3;
                                check_user
                                restrict_user
			fi
			;;
		*)
			echo "This is a catch -all scenario"
			echo "Your formatting was not correct"
			man_page
			usage
			;;
	esac
echo $display_help
done
#echo $display_help
